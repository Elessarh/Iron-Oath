<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HÃ´tel des Ventes - Iron Oath</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Exo+2:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/components/hdv.css">
    <link rel="stylesheet" href="../css/components/item-selector.css">
    <link rel="stylesheet" href="../css/components/mailbox-improved.css">
    <link rel="stylesheet" href="../css/components/security.css">
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userInfo = document.getElementById('user-info');
            
            // Masquer les infos utilisateur par dÃ©faut - elles ne s'affichent que si connectÃ©
            if (userInfo) {
                userInfo.style.display = 'none';
                userInfo.classList.remove('show');
                userInfo.classList.remove('js-visible');
            }
            
            // Le bouton de connexion reste visible par dÃ©faut
            // Il sera masquÃ© par checkAuthState() si l'utilisateur est connectÃ©
        });
    </script>
</head>
<body>
    <!-- Header et Navigation -->
    <header class="header">
        <nav class="nav-container">
            <div class="nav-logo-container">
                <a href="about.html">
                    <img src="../assets/Logo_3.png" alt="Iron Oath Logo" class="nav-logo-safe">
                </a>
            </div>
            <ul class="nav-menu" id="nav-menu">
                <li><a href="../index.html" class="nav-link">Accueil</a></li>
                <li><a href="map.html" class="nav-link">Carte</a></li>
                <li><a href="bestiaire.html" class="nav-link">Bestiaire</a></li>
                <li><a href="items.html" class="nav-link">Items</a></li>
                <li><a href="hdv.html" class="nav-link active">HDV</a></li>
                <li><a href="quetes.html" class="nav-link">QuÃªtes</a></li>
            </ul>
            <div class="nav-connexion">
                <span id="user-info" class="user-info" style="display: none;">
                    <span id="username"></span>
                    <button id="logout-btn" class="logout-btn">DÃ©connexion</button>
                </span>
                <a href="connexion.html" class="nav-link connexion-link" id="login-link">Connexion</a>
            </div>
            <button class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </nav>
    </header>

    <!-- Contenu principal -->
    <main class="main-content">
        <!-- Section Hero -->
        <section class="hero-section">
            <div class="hero-content">
                <h1 class="hero-title">ğŸª HÃ´tel des Ventes</h1>
                <p class="hero-subtitle">MarchÃ© central d'Aincrad - Ã‰changez vos trÃ©sors entre aventuriers</p>
            </div>
        </section>

        <!-- Interface HDV -->
        <section class="hdv-interface">
            <div class="container">
                <!-- Onglets -->
                <div class="hdv-tabs">
                    <button class="hdv-tab active" data-tab="marketplace">ğŸ’° Place du MarchÃ©</button>
                    <button class="hdv-tab" data-tab="my-orders">ğŸ“‹ Mes Ordres</button>
                    <button class="hdv-tab" data-tab="create-order">ğŸ’ CrÃ©er un Ordre</button>
                    <button class="hdv-tab mailbox-tab" onclick="if(window.mailboxSystem && window.mailboxSystem.openMailbox) { window.mailboxSystem.openMailbox(); } else { alert('SystÃ¨me de messagerie en cours de chargement...'); }">
                        ğŸ“¬ BoÃ®te Mail
                        <span id="unread-count" class="unread-count" style="display: none;"></span>
                    </button>
                </div>

                <!-- Contenu des onglets -->
                <div class="hdv-content">
                    <!-- Place du MarchÃ© -->
                    <div id="marketplace" class="hdv-panel active">
                        <div class="hdv-filters">
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label>Type d'ordre :</label>
                                    <select id="type-filter">
                                        <option value="all">Tous les ordres</option>
                                        <option value="sell">ğŸ”´ Ventes</option>
                                        <option value="buy">ğŸ”µ Achats</option>
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label>CatÃ©gorie :</label>
                                    <select id="category-filter">
                                        <option value="all">Toutes catÃ©gories</option>
                                        <option value="Armes">âš”ï¸ Armes</option>
                                        <option value="Accessoires">ğŸ’ Accessoires</option>
                                        <option value="Consommables">ğŸ§ª Consommables</option>
                                        <option value="Familiers">ğŸ¾ Familiers</option>
                                        <option value="Montures">ğŸ Montures</option>
                                        <option value="Outils">ğŸ› ï¸ Outils</option>
                                        <option value="Ressources">â›ï¸ Ressources</option>
                                        <option value="Runes">ğŸ”® Runes</option>
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label>RaretÃ© :</label>
                                    <select id="rarity-filter">
                                        <option value="all">Toutes raretÃ©s</option>
                                        <option value="common">âšª Commun</option>
                                        <option value="uncommon">ğŸŸ¢ Peu commun</option>
                                        <option value="rare">ğŸ”µ Rare</option>
                                        <option value="epic">ğŸŸ£ Ã‰pique</option>
                                        <option value="legendary">ğŸŸ  LÃ©gendaire</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="filter-row">
                                <div class="search-group">
                                    <input type="text" id="search-input" placeholder="ğŸ” Rechercher un item...">
                                    <button id="search-btn" class="search-btn">Rechercher</button>
                                </div>
                                
                                <div class="action-group">
                                    <button id="refresh-btn" class="refresh-btn">ğŸ”„ Actualiser</button>
                                    <span id="orders-count" class="orders-count">0 ordres</span>
                                </div>
                            </div>
                        </div>

                        <!-- Liste des ordres -->
                        <div id="orders-list" class="orders-list">
                            <!-- Le contenu sera chargÃ© dynamiquement -->
                        </div>
                    </div>

                    <!-- Mes Ordres -->
                    <div id="my-orders" class="hdv-panel">
                        <div class="my-orders-header">
                            <h3>ğŸ“‹ Mes Ordres Actifs</h3>
                            <button class="refresh-btn">ğŸ”„ Actualiser</button>
                        </div>
                        
                        <div id="my-orders-list" class="orders-list">
                            <div class="empty-state">
                                <p>ğŸ·ï¸ Vous n'avez aucun ordre actif</p>
                                <p>CrÃ©ez votre premier ordre pour commencer Ã  Ã©changer !</p>
                            </div>
                        </div>
                    </div>

                    <!-- CrÃ©er un Ordre -->
                    <div id="create-order" class="hdv-panel">
                        <div class="create-order-header">
                            <h3>ğŸ’ CrÃ©er un Nouvel Ordre</h3>
                            <p>Choisissez si vous voulez vendre un item ou en acheter un</p>
                        </div>
                        
                        <div class="order-type-selection">
                            <div class="order-type-card" data-type="sell">
                                <div class="order-type-icon">ğŸ’°</div>
                                <h4>ğŸ”¥ Vendre un Item</h4>
                                <p>Vous possÃ©dez cet item et souhaitez le vendre</p>
                            </div>
                            
                            <div class="order-type-card" data-type="buy">
                                <div class="order-type-icon">ğŸ›’</div>
                                <h4>ğŸ’ Acheter un Item</h4>
                                <p>Vous cherchez cet item et proposez un prix</p>
                            </div>
                        </div>
                        
                        <form id="create-order-form" class="create-order-form" style="display: none;">
                            <div class="order-type-display">
                                <h4 id="order-type-label">Type d'ordre sÃ©lectionnÃ©</h4>
                            </div>
                            
                            <div class="form-section">
                                <h4>ğŸ“¦ SÃ©lection de l'Item</h4>
                                
                                <div class="item-selection">
                                    <button type="button" id="open-item-selector" class="item-selector-btn">
                                        ğŸ’ SÃ©lectionner un Item
                                    </button>
                                </div>
                                
                                <div id="selected-item" style="display: none;">
                                    <div class="selected-item-display">
                                        <div class="selected-item-image">
                                            <img id="selected-item-img" src="" alt="">
                                        </div>
                                        <div class="selected-item-info">
                                            <h5 id="selected-item-name"></h5>
                                            <button type="button" id="change-item" class="change-item-btn">ğŸ”„ Changer</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <h4>ğŸ’° DÃ©tails de l'Ordre</h4>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="quantity">QuantitÃ© :</label>
                                        <input type="number" name="quantity" id="quantity" min="1" max="999" value="1" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="price">Prix (cols) :</label>
                                        <input type="number" name="price" id="price" min="1" max="999999" placeholder="1000" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="notes">Notes (optionnel) :</label>
                                    <textarea name="notes" id="notes" placeholder="Informations supplÃ©mentaires..."></textarea>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="cancel-btn">âŒ Annuler</button>
                                <button type="submit" class="submit-btn">âœ… CrÃ©er l'Ordre</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Scripts -->
    <script src="../js/security.js?v=20251108c"></script>
    <script type="module" src="../js/auth-supabase.js?v=20251108c"></script>
    <script src="../js/hdv-supabase.js?v=20251108c"></script>
    <script src="../js/mailbox-supabase.js?v=20251108e"></script>
    <script src="../js/mailbox.js?v=20251108e"></script>
    <script src="../js/migration-hdv.js?v=20251108c"></script>
    <script src="../js/item-selector.js?v=20251108c"></script>
    <script src="../js/items-catalog.js?v=20251108c"></script>
    <script src="../js/hdv.js?v=20251108c"></script>
    
    <script>
        // Initialisation du systÃ¨me HDV
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”„ Chargement HDV...');
            
            // Attendre que tous les scripts soient chargÃ©s
            setTimeout(() => {
                if (typeof HDVSystem !== 'undefined') {
                    console.log('ğŸª Initialisation HDV System...');
                    window.hdvSystem = new HDVSystem();
                    
                    // Initialiser aussi le systÃ¨me de boÃ®te mail
                    if (typeof MailboxSystem !== 'undefined') {
                        console.log('ğŸ“¬ Initialisation Mailbox System...');
                        window.mailboxSystem = new MailboxSystem();
                    } else {
                        console.warn('âš ï¸ MailboxSystem non disponible');
                    }
                    
                    // Exposer les mÃ©thodes de debug
                    window.hdvDebug = {
                        checkAuth: () => window.hdvSystem.checkAuthStatus(),
                        forceAccess: (username) => window.hdvSystem.forceAccess(username),
                        // Debug de la boÃ®te mail
                        testMailbox: () => {
                            console.log('ğŸ” === TEST MAILBOX ===');
                            console.log('ğŸ“¦ window.mailboxSystem:', !!window.mailboxSystem);
                            console.log('ğŸ“¦ MailboxSystem:', typeof MailboxSystem);
                            if (window.mailboxSystem) {
                                console.log('ğŸ“¦ openMailbox method:', typeof window.mailboxSystem.openMailbox);
                                console.log('ğŸ“¦ mailboxSystem keys:', Object.keys(window.mailboxSystem));
                            }
                            return 'Test terminÃ© - vÃ©rifiez la console';
                        },
                        // Fonction pour crÃ©er un ordre de test
                        createTestOrder: () => {
                            const testOrder = {
                                id: Date.now(),
                                creator: 'TestTrader',
                                seller: 'TestTrader',
                                type: 'sell',
                                item: {
                                    name: 'Ã‰pÃ©e de Test',
                                    image: '../assets/items/Armes/sword_001.png'
                                },
                                price: 100,
                                timestamp: new Date().toISOString()
                            };
                            window.hdvSystem.orders.push(testOrder);
                            window.hdvSystem.displayOrders();
                            console.log('ğŸ§ª Ordre de test crÃ©Ã©:', testOrder);
                            return testOrder;
                        },
                        // Fonction pour vÃ©rifier les messages
                        checkMessages: () => {
                            if (window.mailboxSystem) {
                                console.log('ğŸ“¬ Messages dans la boÃ®te mail:', window.mailboxSystem.messages);
                                return window.mailboxSystem.messages;
                            } else {
                                console.log('âŒ SystÃ¨me de boÃ®te mail non disponible');
                                return null;
                            }
                        }
                    };
                    
                    console.log('ğŸ”§ Debug disponible: hdvDebug.checkAuth() et hdvDebug.forceAccess("nom")');
                } else {
                    console.error('âŒ HDVSystem non trouvÃ©');
                    // Redirection vers la connexion si HDV non disponible
                    setTimeout(() => {
                        window.location.href = '../pages/connexion.html';
                    }, 2000);
                }
                
                // Initialiser le compteur de messages non lus
                if (window.mailboxSystem) {
                    updateUnreadCounter();
                    // Mettre Ã  jour toutes les 30 secondes
                    setInterval(updateUnreadCounter, 30000);
                }
            }, 1000); // AugmentÃ© le dÃ©lai pour laisser le temps Ã  l'auth de se charger
        });
        
        // Fonction pour mettre Ã  jour le compteur de messages non lus
        function updateUnreadCounter() {
            if (window.mailboxSystem) {
                const unreadCount = mailboxSystem.getUnreadCount();
                const counter = document.getElementById('unread-count');
                
                if (counter) {
                    if (unreadCount > 0) {
                        counter.textContent = unreadCount;
                        counter.style.display = 'flex';
                    } else {
                        counter.style.display = 'none';
                    }
                }
            }
        }
    </script>
    
    <!-- Script de test HDV (dev) -->
    <script src="../js/hdv-tests.js"></script>
</body>
</html>